<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CMTK Alignment Status - Fly Brain</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: Arial, sans-serif; background: #f5f5f5; color: #333; }

        .header {
            background: #2c3e50; color: white; padding: 15px 30px;
            display: flex; align-items: center; justify-content: space-between;
        }
        .header h1 { font-size: 20px; }
        .header .nav { display: flex; align-items: center; gap: 10px; }
        .header button {
            background: #3498db; color: white; border: none; padding: 6px 14px;
            border-radius: 4px; cursor: pointer; font-size: 13px;
        }
        .header button:hover { background: #2980b9; }

        .container { max-width: 1200px; margin: 20px auto; padding: 0 20px; }

        .status-overview {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;
            margin-bottom: 30px;
        }
        .status-card {
            background: white; padding: 20px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            text-align: center;
        }
        .status-card h3 { color: #2c3e50; margin-bottom: 10px; }
        .status-card .count { font-size: 2em; font-weight: bold; color: #3498db; }

        .section {
            background: white; border-radius: 8px; padding: 20px; margin-bottom: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .section h2 {
            color: #2c3e50; margin-bottom: 15px; padding-bottom: 10px;
            border-bottom: 2px solid #ecf0f1;
        }

        .job-list { display: flex; flex-direction: column; gap: 10px; }
        .job-item {
            display: flex; align-items: center; justify-content: space-between;
            padding: 15px; border: 1px solid #ecf0f1; border-radius: 6px;
            background: #fafafa;
        }
        .job-item.processing { background: #fff3cd; border-color: #ffeaa7; }
        .job-item.completed { background: #d4edda; border-color: #c3e6cb; }
        .job-item.failed { background: #f8d7da; border-color: #f5c6cb; }

        .job-info { flex: 1; }
        .job-name { font-weight: bold; color: #2c3e50; }
        .job-status { font-size: 12px; color: #7f8c8d; margin-top: 2px; }
        .job-time { font-size: 11px; color: #95a5a6; }

        .job-meta { text-align: right; font-size: 12px; }
        .queue-position { color: #e74c3c; font-weight: bold; }

        .loading {
            text-align: center; padding: 40px; color: #7f8c8d;
        }
        .loading .spinner {
            display: inline-block; width: 30px; height: 30px;
            border: 3px solid #ddd; border-top-color: #3498db;
            border-radius: 50%; animation: spin 0.8s linear infinite;
            margin-bottom: 10px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        .empty-state {
            text-align: center; padding: 40px; color: #7f8c8d;
        }

        .refresh-btn {
            background: #27ae60; color: white; border: none; padding: 8px 16px;
            border-radius: 4px; cursor: pointer; font-size: 14px;
            margin-bottom: 20px;
        }
        .refresh-btn:hover { background: #229954; }

        .error-msg { color: #e74c3c; font-size: 12px; margin-top: 5px; }

        .retry-btn {
            background: #f39c12; color: white; border: none; padding: 4px 10px;
            border-radius: 3px; cursor: pointer; font-size: 11px; margin-top: 5px;
        }
        .retry-btn:hover { background: #e67e22; }
    </style>
</head>
<body>
    <div class="header">
        <h1>CMTK Alignment Status</h1>
        <div class="nav">
            <button onclick="window.location.href='/'">← Back to Review</button>
            <button onclick="queueAllApproved()">Queue All Approved</button>
            <button class="refresh-btn" onclick="loadStatus()">Refresh</button>
        </div>
    </div>

    <div class="container">
        <div class="status-overview">
            <div class="status-card">
                <h3>Queued</h3>
                <div class="count" id="queued-count">0</div>
            </div>
            <div class="status-card">
                <h3>Processing</h3>
                <div class="count" id="processing-count">0</div>
            </div>
            <div class="status-card">
                <h3>Completed</h3>
                <div class="count" id="completed-count">0</div>
            </div>
            <div class="status-card">
                <h3>Failed</h3>
                <div class="count" id="failed-count">0</div>
            </div>
        </div>

        <div class="section">
            <h2>Currently Processing</h2>
            <div id="processing-section">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Loading status...</p>
                </div>
            </div>
        </div>

        <div class="section">
            <h2>Queued Jobs</h2>
            <div id="queued-section">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Loading queue...</p>
                </div>
            </div>
        </div>

        <div class="section">
            <h2>Completed Jobs</h2>
            <div id="completed-section">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Loading completed jobs...</p>
                </div>
            </div>
        </div>

        <div class="section">
            <h2>Failed Jobs</h2>
            <div id="failed-section">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Loading failed jobs...</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        let statusData = null;

        function loadStatus() {
            fetch('/api/alignment-status')
                .then(r => r.json())
                .then(data => {
                    statusData = data;
                    updateOverview();
                    renderProcessing();
                    renderQueued();
                    renderCompleted();
                    renderFailed();
                })
                .catch(err => {
                    console.error('Failed to load status:', err);
                    showError('Failed to load alignment status');
                });
        }

        function updateOverview() {
            const counts = {
                queued: 0,
                processing: 0,
                completed: 0,
                failed: 0
            };

            statusData.forEach(job => {
                counts[job.status] = (counts[job.status] || 0) + 1;
            });

            document.getElementById('queued-count').textContent = counts.queued || 0;
            document.getElementById('processing-count').textContent = counts.processing || 0;
            document.getElementById('completed-count').textContent = counts.completed || 0;
            document.getElementById('failed-count').textContent = counts.failed || 0;
        }

        function renderProcessing() {
            const processing = statusData.filter(job => job.status === 'processing');
            const container = document.getElementById('processing-section');

            if (processing.length === 0) {
                container.innerHTML = '<div class="empty-state">No jobs currently processing</div>';
                return;
            }

            const html = processing.map(job => `
                <div class="job-item processing">
                    <div class="job-info">
                        <div class="job-name">${job.image_base}</div>
                        <div class="job-status">Processing since ${formatTime(job.queued_at)}</div>
                        <div class="job-time">Progress: ${job.progress || 0}%</div>
                    </div>
                    <div class="job-meta">
                        <div class="queue-position">PROCESSING</div>
                    </div>
                </div>
            `).join('');

            container.innerHTML = `<div class="job-list">${html}</div>`;
        }

        function renderQueued() {
            const queued = statusData.filter(job => job.status === 'queued');
            const container = document.getElementById('queued-section');

            if (queued.length === 0) {
                container.innerHTML = '<div class="empty-state">No jobs in queue</div>';
                return;
            }

            const html = queued.map(job => `
                <div class="job-item">
                    <div class="job-info">
                        <div class="job-name">${job.image_base}</div>
                        <div class="job-status">Queued at ${formatTime(job.queued_at)}</div>
                    </div>
                    <div class="job-meta">
                        <div class="queue-position">Position ${job.queue_position}</div>
                    </div>
                </div>
            `).join('');

            container.innerHTML = `<div class="job-list">${html}</div>`;
        }

        function renderCompleted() {
            const completed = statusData.filter(job => job.status === 'completed')
                .sort((a, b) => new Date(b.completed_at) - new Date(a.completed_at));
            const container = document.getElementById('completed-section');

            if (completed.length === 0) {
                container.innerHTML = '<div class="empty-state">No completed jobs</div>';
                return;
            }

            const html = completed.map(job => `
                <div class="job-item completed">
                    <div class="job-info">
                        <div class="job-name">${job.image_base}</div>
                        <div class="job-status">Completed at ${formatTime(job.completed_at)}</div>
                        <div class="job-time">Queued: ${formatTime(job.queued_at)}</div>
                    </div>
                    <div class="job-meta">
                        <div>✅ Success</div>
                    </div>
                </div>
            `).join('');

            container.innerHTML = `<div class="job-list">${html}</div>`;
        }

        function renderFailed() {
            const failed = statusData.filter(job => job.status === 'failed')
                .sort((a, b) => new Date(b.completed_at || b.queued_at) - new Date(a.completed_at || a.queued_at));
            const container = document.getElementById('failed-section');

            if (failed.length === 0) {
                container.innerHTML = '<div class="empty-state">No failed jobs</div>';
                return;
            }

            const html = failed.map(job => `
                <div class="job-item failed">
                    <div class="job-info">
                        <div class="job-name">${job.image_base}</div>
                        <div class="job-status">Failed at ${formatTime(job.completed_at)}</div>
                        <div class="job-time">Queued: ${formatTime(job.queued_at)}</div>
                        <div class="error-msg">${job.error || 'Unknown error'}</div>
                    </div>
                    <div class="job-meta">
                        <div>❌ Failed</div>
                        <button class="retry-btn" onclick="retryJob('${job.image_base}')">Retry</button>
                    </div>
                </div>
            `).join('');

            container.innerHTML = `<div class="job-list">${html}</div>`;
        }

        async function retryJob(imageBase) {
            try {
                const response = await fetch('/api/queue-alignment', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ image_base: imageBase })
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const result = await response.json();
                if (result.success) {
                    alert(`Successfully re-queued ${imageBase} for alignment`);
                    loadStatus(); // Refresh the status
                } else {
                    throw new Error(result.error || 'Failed to queue alignment');
                }
            } catch (error) {
                showError(`Failed to retry ${imageBase}: ${error.message}`);
            }
        }

        async function queueAllApproved() {
            try {
                // First get all approved images
                const response = await fetch('/api/images');
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                const images = await response.json();

                const approvedImages = images.filter(img => img.approved);
                if (approvedImages.length === 0) {
                    alert('No approved images found');
                    return;
                }

                let successCount = 0;
                let errorCount = 0;

                // Queue each approved image
                for (const image of approvedImages) {
                    try {
                        const queueResponse = await fetch('/api/queue-alignment', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({ image_base: image.base_name })
                        });

                        if (queueResponse.ok) {
                            const result = await queueResponse.json();
                            if (result.success) {
                                successCount++;
                            } else {
                                errorCount++;
                            }
                        } else {
                            errorCount++;
                        }
                    } catch (error) {
                        errorCount++;
                        console.error(`Failed to queue ${image.base_name}:`, error);
                    }
                }

                alert(`Queued ${successCount} images successfully${errorCount > 0 ? `, ${errorCount} failed` : ''}`);
                loadStatus(); // Refresh the status

            } catch (error) {
                showError(`Failed to queue approved images: ${error.message}`);
            }
        }

        function formatTime(isoString) {
            if (!isoString) return 'Unknown';
            const date = new Date(isoString);
            return date.toLocaleString();
        }

        function showError(message) {
            // Simple error display - could be enhanced
            alert(message);
        }

        // Auto-refresh every 30 seconds
        setInterval(loadStatus, 30000);

        // Initial load
        loadStatus();
    </script>
</body>
</html>